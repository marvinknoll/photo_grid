<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Photo Grid App</title>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        margin: 10px;
        background-color: #f9f9f9;
        color: #333;
      }
      .drop-area {
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        background-color: #fff;
        cursor: pointer;
        margin-bottom: 10px;
        transition: background-color 0.3s;
      }
      .drop-area.dragover {
        background-color: #e0f7fa;
        border-color: #00796b;
      }
      #grid {
        display: grid;
        grid-template-columns: repeat(4, 160px);
        gap: 6px;
        margin-bottom: 10px;
        justify-content: center;
      }
      .photo-box {
        width: 160px;
        height: 160px;
        position: relative;
        overflow: hidden;
        border: 2px solid #ccc;
        background: #eee;
        cursor: grab;
        border-radius: 6px;
      }
      .photo-box img {
        position: absolute;
        user-drag: none;
        user-select: none;
        -webkit-user-drag: none;
        -webkit-user-select: none;
      }
      button {
        background-color: #00796b;
        color: white;
        border: none;
        padding: 10px 18px;
        font-size: 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s;
        display: block;
        margin: 0 auto;
      }
      button:hover {
        background-color: #004d40;
      }
      #downloadLink {
        display: none;
        margin-top: 10px;
        font-size: 16px;
        text-align: center;
      }

      /* Responsive adjustments for smaller screens */
      @media (max-width: 700px) {
        #grid {
          grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
          width: 100%;
        }
        .photo-box {
          width: 100%;
          height: 120px;
        }
      }
    </style>
  </head>
  <body>
    <div id="dropArea" class="drop-area">
      Drag & Drop images here or click to select (max 12)
      <input id="fileInput" type="file" multiple accept="image/*" hidden />
    </div>
    <div id="grid"></div>
    <button id="generateBtn">Generate Image</button>
    <a id="downloadLink" href="#" download="photo-grid.png"
      >Download Merged Image</a
    >

    <script>
      const dropArea = document.getElementById("dropArea");
      const fileInput = document.getElementById("fileInput");
      const grid = document.getElementById("grid");
      const generateBtn = document.getElementById("generateBtn");
      const downloadLink = document.getElementById("downloadLink");

      const cols = 4;
      const rows = 3;
      const boxSizeDefault = 160;
      const boxSizeMobile = 120;
      const maxPhotos = cols * rows;
      let photos = [];

      function getBoxSize() {
        return window.innerWidth <= 700 ? boxSizeMobile : boxSizeDefault;
      }

      function createGridBoxes() {
        grid.innerHTML = "";
        for (let i = 0; i < maxPhotos; i++) {
          const box = document.createElement("div");
          box.className = "photo-box";
          box.dataset.index = i;
          grid.appendChild(box);
        }
      }
      createGridBoxes();

      dropArea.addEventListener("click", () => fileInput.click());
      dropArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropArea.classList.add("dragover");
      });
      dropArea.addEventListener("dragleave", () => {
        dropArea.classList.remove("dragover");
      });
      dropArea.addEventListener("drop", (e) => {
        e.preventDefault();
        dropArea.classList.remove("dragover");
        handleFiles(e.dataTransfer.files);
      });
      fileInput.addEventListener("change", (e) => handleFiles(e.target.files));

      window.addEventListener("resize", () => {
        // On resize, adjust all images positions and sizes to new box size
        photos.forEach((photo, i) => {
          if (!photo) return;
          setupPhoto(i, photo.img);
        });
      });

      async function handleFiles(files) {
        const selected = Array.from(files).slice(0, maxPhotos);
        photos = [];
        clearGrid();

        for (let i = 0; i < selected.length; i++) {
          let file = selected[i];

          if (file.name.toLowerCase().endsWith(".heic")) {
            try {
              const blob = await heic2any({
                blob: file,
                toType: "image/jpeg",
                quality: 0.9,
              });
              file = new File([blob], file.name.replace(/\.heic$/i, ".jpg"), {
                type: "image/jpeg",
              });
            } catch (err) {
              console.error("HEIC conversion failed", err);
              continue;
            }
          }

          const url = URL.createObjectURL(file);
          const img = new Image();
          img.src = url;
          await new Promise((resolve) => {
            img.onload = () => {
              setupPhoto(i, img);
              resolve();
            };
          });
        }
      }

      function clearGrid() {
        grid
          .querySelectorAll(".photo-box")
          .forEach((box) => (box.innerHTML = ""));
      }

      function setupPhoto(index, img) {
        const boxSize = getBoxSize();
        const box = grid.querySelector(`.photo-box[data-index="${index}"]`);
        if (!box) return;

        const imgRatio = img.naturalWidth / img.naturalHeight;
        let displayWidth, displayHeight;

        if (imgRatio > 1) {
          displayHeight = boxSize;
          displayWidth = imgRatio * boxSize;
        } else {
          displayWidth = boxSize;
          displayHeight = boxSize / imgRatio;
        }

        img.style.width = displayWidth + "px";
        img.style.height = displayHeight + "px";
        let left = (boxSize - displayWidth) / 2;
        let top = (boxSize - displayHeight) / 2;
        img.style.left = left + "px";
        img.style.top = top + "px";

        let dragStartX,
          dragStartY,
          imgStartLeft,
          imgStartTop,
          dragging = false;
        function clamp(v, min, max) {
          return Math.min(Math.max(v, min), max);
        }

        img.style.cursor = "grab";

        img.addEventListener("mousedown", (e) => {
          dragging = true;
          dragStartX = e.clientX;
          dragStartY = e.clientY;
          imgStartLeft = parseFloat(img.style.left);
          imgStartTop = parseFloat(img.style.top);
          img.style.cursor = "grabbing";
          e.preventDefault();
        });

        window.addEventListener("mousemove", (e) => {
          if (!dragging) return;
          const dx = e.clientX - dragStartX;
          const dy = e.clientY - dragStartY;
          let newLeft = clamp(imgStartLeft + dx, boxSize - displayWidth, 0);
          let newTop = clamp(imgStartTop + dy, boxSize - displayHeight, 0);
          img.style.left = newLeft + "px";
          img.style.top = newTop + "px";
          photos[index].offsetX = newLeft;
          photos[index].offsetY = newTop;
        });

        window.addEventListener("mouseup", () => {
          if (dragging) {
            dragging = false;
            img.style.cursor = "grab";
          }
        });

        // Support touch events for mobile drag
        img.addEventListener("touchstart", (e) => {
          dragging = true;
          const touch = e.touches[0];
          dragStartX = touch.clientX;
          dragStartY = touch.clientY;
          imgStartLeft = parseFloat(img.style.left);
          imgStartTop = parseFloat(img.style.top);
          img.style.cursor = "grabbing";
          e.preventDefault();
        });

        window.addEventListener("touchmove", (e) => {
          if (!dragging) return;
          const touch = e.touches[0];
          const dx = touch.clientX - dragStartX;
          const dy = touch.clientY - dragStartY;
          let newLeft = clamp(imgStartLeft + dx, boxSize - displayWidth, 0);
          let newTop = clamp(imgStartTop + dy, boxSize - displayHeight, 0);
          img.style.left = newLeft + "px";
          img.style.top = newTop + "px";
          photos[index].offsetX = newLeft;
          photos[index].offsetY = newTop;
        });

        window.addEventListener("touchend", () => {
          if (dragging) {
            dragging = false;
            img.style.cursor = "grab";
          }
        });

        box.innerHTML = "";
        box.appendChild(img);

        photos[index] = {
          img,
          offsetX: left,
          offsetY: top,
          displayWidth,
          displayHeight,
          naturalWidth: img.naturalWidth,
          naturalHeight: img.naturalHeight,
        };
      }

      generateBtn.addEventListener("click", () => {
        if (photos.length === 0) {
          alert("Please load some images first.");
          return;
        }
        generateMergedImage();
      });

      function generateMergedImage() {
        const exportScale = 2.5;
        const boxSize = getBoxSize();
        const canvasWidth = cols * boxSize * exportScale;
        const canvasHeight = rows * boxSize * exportScale;
        const canvas = document.createElement("canvas");
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);

        for (let i = 0; i < maxPhotos; i++) {
          const photo = photos[i];
          if (!photo) continue;

          const col = i % cols;
          const row = Math.floor(i / cols);
          const destX = col * boxSize;
          const destY = row * boxSize;

          const scaleX = photo.naturalWidth / photo.displayWidth;
          const scaleY = photo.naturalHeight / photo.displayHeight;

          const srcX = -photo.offsetX * scaleX;
          const srcY = -photo.offsetY * scaleY;
          const srcWidth = boxSize * scaleX;
          const srcHeight = boxSize * scaleY;

          ctx.drawImage(
            photo.img,
            srcX,
            srcY,
            srcWidth,
            srcHeight,
            destX * exportScale,
            destY * exportScale,
            boxSize * exportScale,
            boxSize * exportScale
          );
        }

        const dataURL = canvas.toDataURL("image/png");
        downloadLink.href = dataURL;
        downloadLink.style.display = "inline-block";
        downloadLink.click();
      }
    </script>
  </body>
</html>
